<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Funbox Studio - Play</title>
<style>
  body { margin:0; overflow:hidden; background:#000; }
  #ui{
    position:fixed;top:20px;left:20px;color:#444;
    font-family:'Arial Rounded MT Bold',sans-serif;
    background:rgba(255,255,255,.9);
    padding:15px;border-radius:20px;z-index:10;
    box-shadow:0 4px 15px rgba(0,0,0,.1);
  }
</style>
</head>
<body>

<div id="ui">
üì¶üõ†Ô∏è <b>Funbox Studio</b><br>
WASD: Moverse | <b>Shift</b>: Correr | <b>C</b>: Agacharse | <b>R</b>: C√°mara Frontal
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
<script>
/* ================= CONFIG ================= */
const config = JSON.parse(localStorage.getItem("funbox_config")) || {
  floorColor:"#eeeeee", floorSize:500, skyColor:"#87ceeb", ambientIntensity:.9
};
const mapData = JSON.parse(localStorage.getItem("funbox_map")) || [];
const scene = new THREE.Scene();
scene.background = new THREE.Color(config.skyColor);
scene.fog = new THREE.FogExp2(config.skyColor, config.skyColor==="#1a1a2e"?0.05:0.01);

const camera = new THREE.PerspectiveCamera(75,innerWidth/innerHeight,.1,5000);
const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth,innerHeight);
renderer.shadowMap.enabled=true;
renderer.toneMapping=THREE.ACESFilmicToneMapping;
document.body.appendChild(renderer.domElement);

/* ================= LUCES ================= */
scene.add(new THREE.HemisphereLight(config.skyColor,config.floorColor,.6));
scene.add(new THREE.AmbientLight(0xffffff,config.ambientIntensity*.5));
const sun=new THREE.DirectionalLight(0xffffff,config.ambientIntensity);
sun.position.set(50,100,50);sun.castShadow=true;
sun.shadow.mapSize.set(2048,2048);
scene.add(sun);

/* ================= SUELO ================= */
const floor=new THREE.Mesh(
 new THREE.PlaneGeometry(config.floorSize,config.floorSize),
 new THREE.MeshStandardMaterial({color:config.floorColor,roughness:.8})
);
floor.rotation.x=-Math.PI/2;floor.receiveShadow=true;
scene.add(floor);

/* ================= BLOQUES ================= */
const physicalBlocks=[floor];
const boxGeo=new THREE.BoxGeometry(1,1,1);
const boxMat=new THREE.MeshStandardMaterial({color:0x2196f3});
let spawnPoint=new THREE.Vector3(0,0,0);

mapData.forEach(b=>{
 let block;
 if(b.type==="spawn"){
  block=new THREE.Mesh(new THREE.BoxGeometry(1.2,.1,1.2),
   new THREE.MeshStandardMaterial({color:0xffffff,emissive:0xffffff,emissiveIntensity:.4}));
  block.position.set(b.x+.5,.05,b.y+.5);
  spawnPoint.set(block.position.x,0,block.position.z);
  physicalBlocks.push(block);
 }else{
  block=new THREE.Mesh(boxGeo,boxMat);
  block.position.set(b.x+.5,.5,b.y+.5);
  physicalBlocks.push(block);
 }
 block.castShadow=true;block.receiveShadow=true;
 scene.add(block);
});

/* ================= COLISIONES ================= */
function getSurfaceY(pos){
 let y=-100;
 physicalBlocks.forEach(b=>{
  const bb=new THREE.Box3().setFromObject(b);
  if(pos.x>bb.min.x&&pos.x<bb.max.x&&pos.z>bb.min.z&&pos.z<bb.max.z)
   y=Math.max(y,bb.max.y);
 });
 return y;
}
function isColliding(pos){
 for(const b of physicalBlocks){
  const bb=new THREE.Box3().setFromObject(b);
  if(pos.x>bb.min.x-.3&&pos.x<bb.max.x+.3&&
     pos.z>bb.min.z-.3&&pos.z<bb.max.z+.3&&
     pos.y<bb.max.y-.1) return true;
 }
 return false;
}

/* ========================================================= */
/* =============== PERSONAJE MEJORADO ====================== */
/* ========================================================= */

const player=new THREE.Group();
player.position.copy(spawnPoint);
scene.add(player);

const cuerpoVisual=new THREE.Group();
player.add(cuerpoVisual);

let piernaI,piernaD,brazoI,brazoD,cabezaMesh,cabezaGroup;
const listaOjos=[];
let breath=0;

function buildPlayerModel(){
 const skinMat=new THREE.MeshStandardMaterial({color:0xc4a484,roughness:.6});
 const shirtMat=new THREE.MeshStandardMaterial({color:0x2b1d16,roughness:.85});
 const pantsMat=new THREE.MeshStandardMaterial({color:0x4d4d4d,roughness:.85});
 const hairMat=new THREE.MeshStandardMaterial({color:0x1a1a1a,roughness:.9});

 cabezaGroup=new THREE.Group();
 cabezaGroup.position.y=.78;
 cuerpoVisual.add(cabezaGroup);

 cabezaMesh=new THREE.Mesh(new THREE.BoxGeometry(.42,.42,.42),skinMat);
 cabezaMesh.castShadow=true;
 cabezaGroup.add(cabezaMesh);

 const hairTop=new THREE.Mesh(new THREE.BoxGeometry(.44,.12,.44),hairMat);
 hairTop.position.y=.22;
 cabezaMesh.add(hairTop);

 function eye(x){
  const g=new THREE.Group();
  const p=new THREE.Mesh(new THREE.SphereGeometry(.075,16,16),
   new THREE.MeshStandardMaterial({color:0x000000,emissive:0x111111}));
  p.scale.z=.3;
  g.add(p);g.position.set(x,-.07,.22);
  listaOjos.push(g);return g;
 }
 cabezaMesh.add(eye(-.12),eye(.12));

 const torso=new THREE.Mesh(
  new THREE.CapsuleGeometry(.19,.38,8,16),shirtMat);
 torso.position.y=.36;torso.castShadow=true;
 cuerpoVisual.add(torso);

 const armGeo=new THREE.CapsuleGeometry(.065,.22,8,12);
 brazoI=new THREE.Mesh(armGeo,shirtMat);
 brazoD=brazoI.clone();
 brazoI.position.set(-.26,.46,0);
 brazoD.position.x=.26;
 cuerpoVisual.add(brazoI,brazoD);

 const legGeo=new THREE.CapsuleGeometry(.085,.28,8,12);
 piernaI=new THREE.Mesh(legGeo,pantsMat);
 piernaD=piernaI.clone();
 piernaI.position.set(-.12,.25,0);
 piernaD.position.x=.12;
 cuerpoVisual.add(piernaI,piernaD);
}
buildPlayerModel();

/* ================= MOVIMIENTO ================= */
let vy=0,onGround=true;
const gravity=-.015;
const keys={};
let yaw=0,pitch=0,step=0,blink=200;

onkeydown=e=>keys[e.key.toLowerCase()]=true;
onkeyup=e=>keys[e.key.toLowerCase()]=false;

document.body.onclick=()=>document.body.requestPointerLock();
onmousemove=e=>{
 if(document.pointerLockElement){
  yaw-=e.movementX*.003;
  pitch=Math.max(-.5,Math.min(.5,pitch-e.movementY*.003));
 }
};

/* ================= LOOP ================= */
function animate(){
 requestAnimationFrame(animate);

 breath+=.03;
 cuerpoVisual.scale.y=1+Math.sin(breath)*.01;

 const ground=getSurfaceY(player.position);
 player.position.y+=vy;
 if(player.position.y>ground){vy+=gravity;onGround=false;}
 else{player.position.y=ground;vy=0;onGround=true;}

 let dir=new THREE.Vector3();
 if(keys.w)dir.z--;
 if(keys.s)dir.z++;
 if(keys.a)dir.x--;
 if(keys.d)dir.x++;
 if(dir.length()){
  dir.normalize().applyAxisAngle(new THREE.Vector3(0,1,0),yaw);
  const np=player.position.clone().add(dir.multiplyScalar(.09));
  if(!isColliding(np)){player.position.x=np.x;player.position.z=np.z;}
  step+=.2;
  piernaI.rotation.x=Math.sin(step)*.6;
  piernaD.rotation.x=Math.sin(step+Math.PI)*.6;
  brazoI.rotation.x=Math.sin(step+Math.PI)*.6;
  brazoD.rotation.x=Math.sin(step)*.6;
 }

 blink--; if(blink<0)blink=Math.random()*200+100;
 listaOjos.forEach(o=>o.scale.y=blink<8?.1:1);

 player.rotation.y=THREE.MathUtils.lerp(player.rotation.y,yaw+Math.PI,.15);

 const camOff=new THREE.Vector3(0,1.4,3).applyAxisAngle(new THREE.Vector3(0,1,0),yaw);
 camera.position.lerp(player.position.clone().add(camOff),.1);
 camera.lookAt(player.position.clone().add(new THREE.Vector3(0,.7,0)));

 renderer.render(scene,camera);
}
animate();

onresize=()=>{
 camera.aspect=innerWidth/innerHeight;
 camera.updateProjectionMatrix();
 renderer.setSize(innerWidth,innerHeight);
};
</script>
</body>
</html>

