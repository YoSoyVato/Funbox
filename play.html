<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Estados Espa침oles - Prototipo RP</title>
<style>
  body { margin:0; overflow:hidden; background:black; }
  #ui {
    position: fixed;
    top:10px;
    left:10px;
    color:white;
    font-family: Arial;
    background: rgba(0,0,0,0.6);
    padding:10px;
    border-radius:8px;
    z-index:10;
  }
</style>
</head>
<body>

<div id="ui">
  游꿡 **FunboxEngine**<br>
  WASD: Moverse<br>
  Shift: Correr<br>
  Mouse: C치mara<br>
  <small>춰Cuidado con el borde!</small>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
<script>
// ======================
// ESCENA
// ======================
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x87ceeb);

const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

// LUZ
scene.add(new THREE.AmbientLight(0xffffff,0.6));
const sun = new THREE.DirectionalLight(0xffffff,0.8);
sun.position.set(10,20,10);
scene.add(sun);

// SUELO (200x200)
const floorSize = 200;
const floor = new THREE.Mesh(
  new THREE.PlaneGeometry(floorSize, floorSize),
  new THREE.MeshStandardMaterial({color:0x555555})
);
floor.rotation.x = -Math.PI/2;
scene.add(floor);

// ======================
// CAPSULA (JUGADOR)
// ======================
const playerHeight = 2;
const player = new THREE.Mesh(
  new THREE.CapsuleGeometry(0.5, playerHeight),
  new THREE.MeshStandardMaterial({color:0xff0000})
);
player.position.set(0, 5, 0);
scene.add(player);

// ======================
// VARIABLES
// ======================
let velY = 0;
const gravity = -0.01; // Ajustado para que la ca칤da sea m치s suave/realista
let yaw = 0, pitch = 0;
let speed = 0.15;

const keys = {};
let pointerLocked = false;

// ======================
// INPUT
// ======================
window.addEventListener("keydown", e => keys[e.key.toLowerCase()] = true);
window.addEventListener("keyup", e => keys[e.key.toLowerCase()] = false);

document.body.onclick = () => {
  document.body.requestPointerLock();
};

document.addEventListener("pointerlockchange", () => {
  pointerLocked = document.pointerLockElement === document.body;
});

document.addEventListener("mousemove", e => {
  if (!pointerLocked) return;
  yaw -= e.movementX * 0.002;
  pitch -= e.movementY * 0.002;
  pitch = Math.max(-0.6, Math.min(0.6, pitch));
});

// ======================
// LOOP DE ANIMACI칍N
// ======================
function animate(){
  requestAnimationFrame(animate);

  // 1. MOVIMIENTO HORIZONTAL
  let dir = new THREE.Vector3();
  if(keys.w) dir.z -= 1;
  if(keys.s) dir.z += 1;
  if(keys.a) dir.x -= 1;
  if(keys.d) dir.x += 1;

  let moveSpeed = speed;
  if(keys.shift) moveSpeed *= 2;

  if(dir.length() > 0){
    dir.normalize();
    const moveDir = dir.applyAxisAngle(new THREE.Vector3(0,1,0), yaw);
    player.position.addScaledVector(moveDir, moveSpeed);
  }

  // 2. GRAVEDAD (Siempre act칰a)
  velY += gravity;
  player.position.y += velY;

  // 3. L칍GICA DE COLISI칍N (Arreglada)
  const halfSize = floorSize / 2; // Es decir, 100
  const sobreSuelo = Math.abs(player.position.x) <= halfSize && Math.abs(player.position.z) <= halfSize;

  if(sobreSuelo){
    // Si estamos sobre el suelo, no podemos caer m치s all치 de la superficie
    if(player.position.y <= playerHeight/2){
      player.position.y = playerHeight/2;
      velY = 0;
    }
  } 
  // Si NO estamos sobre el suelo (sobreSuelo es false), no hacemos nada y el jugador cae.

  // 4. MUERTE POR CAIDA (Respawn)
  if(player.position.y < -30){
    player.position.set(0, 10, 0); // Te teletransporta arriba al centro
    velY = 0;
  }

  // 5. C츼MARA TERCERA PERSONA
  const camOffset = new THREE.Vector3(0, 2, 6);
  camOffset.applyAxisAngle(new THREE.Vector3(0,1,0), yaw);
  camera.position.copy(player.position).add(camOffset);
  camera.lookAt(player.position.clone().add(new THREE.Vector3(0, playerHeight/2, 0)));

  renderer.render(scene, camera);
}
animate();

// REAJUSTE DE VENTANA
window.addEventListener("resize", ()=>{
  camera.aspect = window.innerWidth/window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
});
</script>
</body>
</html>
